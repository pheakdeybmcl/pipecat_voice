<include>
  <extension name="va_0000000000">
    <condition field="destination_number" expression="^0000000000$">
      <action application="answer"/>

      <!-- Make in-call DTMF more reliable -->
      <action application="set" data="dtmf_type=rfc2833"/>
      <action application="set" data="rtp_dtmf=true"/>
      <action application="set" data="dtmf_duration=240"/>

      <action application="set" data="hangup_after_playback=false"/>
      <!-- For testing: disable media timeouts so calls don't drop if RTP is blocked -->
      <action application="set" data="media_timeout=0"/>
      <action application="set" data="media_hold_timeout=0"/>
      <action application="set" data="rtp_timeout_sec=0"/>
      <action application="set" data="rtp_hold_timeout_sec=0"/>
      <action application="set" data="session_timeout=0"/>
      <action application="set" data="send_silence_when_idle=true"/>
      <action application="set" data="rtp_keepalive=5"/>
      <action application="set" data="hold_music=local_stream://silence"/>
      <action application="set" data="ringback=local_stream://silence"/>
      <action application="set" data="playback_volume=+4"/>

      <action application="set" data="STREAM_SUPPRESS_LOG=false"/>
      <action application="set" data="STREAM_MESSAGE_DEFLATE=false"/>
      <action application="set" data="STREAM_BUFFER_SIZE=20"/>
      <!-- Debug: record inbound (caller) audio only to verify mic/RTP -->
      <action application="set" data="RECORD_READ_ONLY=true"/>
      <action application="set" data="RECORD_WRITE_ONLY=false"/>
      <action application="record_session" data="/tmp/${uuid}_read.wav"/>

      <!-- Language selection -->
      <action application="set" data="lang=en"/>
      <action application="set" data="lang_digit="/>
      <!-- Give RTP a moment to open so the prompt isn't clipped -->
      <action application="playback" data="silence_stream://500"/>
      <!-- "Press 1 for English, 2 for Khmer" -->
      <action application="playback" data="/usr/local/freeswitch/sounds/en/us/callie/8000/ivr/ivr-press.wav"/>
      <action application="playback" data="/usr/local/freeswitch/sounds/en/us/callie/8000/ivr/ivr-one.wav"/>
      <action application="playback" data="/usr/local/freeswitch/sounds/en/us/callie/8000/ivr/ivr-for.wav"/>
      <action application="playback" data="/usr/local/freeswitch/sounds/en/us/callie/8000/ivr/ivr-english.wav"/>
      <action application="playback" data="/usr/local/freeswitch/sounds/en/us/callie/8000/ivr/ivr-press.wav"/>
      <action application="playback" data="/usr/local/freeswitch/sounds/en/us/callie/8000/ivr/ivr-two.wav"/>
      <action application="playback" data="/usr/local/freeswitch/sounds/en/us/callie/8000/ivr/ivr-for.wav"/>
      <action application="playback" data="/usr/local/freeswitch/sounds/en/us/callie/8000/ivr/ivr-language.wav"/>
      <!-- Read 1 digit, 3 tries, 5s timeout -->
      <action application="read" data="1 1 3 5000 # lang_digit /usr/local/freeswitch/sounds/en/us/callie/8000/ivr/ivr-please_enter_extension_followed_by_pound.wav"/>
      <!-- Map digit to language (default to en) -->
      <action application="set" data="lang=${if(${lang_digit}==2,km,en)}"/>

      <!-- Start audio stream with selected language -->
      <!-- WS host/port from globals (set in vars.xml) -->
      <action application="set" data="app_host=${global_app_host}"/>
      <action application="set" data="app_port=${global_app_port}"/>
      <action application="set" data="api_result=${bgapi(uuid_audio_stream ${uuid} start ws://${app_host}:${app_port}/ws_fs?session_id=${uuid}&lang=${lang} mono 16k)}"/>
      <action application="endless_playback" data="silence_stream://-1"/>
    </condition>
  </extension>
</include>
